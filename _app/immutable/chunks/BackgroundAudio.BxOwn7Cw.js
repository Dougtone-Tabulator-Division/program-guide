var Z=Object.defineProperty;var j=(r,t,e)=>t in r?Z(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var P=(r,t,e)=>j(r,typeof t!="symbol"?t+"":t,e);import{s as F,k as N,w as V,e as W,a as x,J as q,c as L,b as S,f as b,g as R,m as M,P as D,i as E,h as $,r as z,v as tt,H as v,x as et,y as G,A as nt}from"./scheduler.Bh2TjGwV.js";import{S as H,i as J,t as k,g as it,a as T,c as st,f as rt,b as at,d as ot,m as lt,e as ut}from"./index.TvtXsUKR.js";import{t as K}from"./tv-state.D_n5rjyU.js";import{w as Q}from"./index.G8hfPIUd.js";import{g as B}from"./audio-mixer.WFKbhp0N.js";const ct=Q({interruptedBy:0}),_=Q({});function ft(r,t,e){let o;N(r,K,m=>e(4,o=m));let{props:s={}}=t,{playContinuously:u=!1}=t,{playBlip:n=!1}=t,a,f,p,c,h,l,d;V(()=>{a=new AudioContext,e(3,h=a.createGain()),l=a.createBiquadFilter(),l.type=s.filterType||"lowpass",l.frequency.value=s.filterFrequency||1e3,p=null,c=!1,f=a.createBuffer(1,a.sampleRate*2,a.sampleRate);let m=f.getChannelData(0);for(let w=0;w<m.length;w++)m[w]=Math.random()*2-1;return u?i():n&&A(Math.floor(Math.random()*90)+20),()=>{clearTimeout(d),g(),a.close()}});function i(){c||(p=a.createBufferSource(),p.buffer=f,p.loop=!0,p.connect(l).connect(h).connect(a.destination),p.start(),c=!0)}function g(){c&&(p&&(p.stop(),p.disconnect(),p=null),c=!1)}function A(m){c||(clearTimeout(d),i(),d=setTimeout(()=>{g()},m))}return r.$$set=m=>{"props"in m&&e(0,s=m.props),"playContinuously"in m&&e(1,u=m.playContinuously),"playBlip"in m&&e(2,n=m.playBlip)},r.$$.update=()=>{r.$$.dirty&25&&h&&(o.isMuting?e(3,h.gain.value=0,h):e(3,h.gain.value=o.volume*2/100*B(s.noise,1),h))},[s,u,n,h,o]}class mt extends H{constructor(t){super(),J(this,t,ft,null,F,{props:0,playContinuously:1,playBlip:2})}}class dt{constructor(){P(this,"supportsLiveUpdates",!1)}async getNowPlayingAsync(t,e){try{const s=await(await fetch(t)).json();return s?{hasData:!0,stationName:s.station.name,title:s.now_playing.song.title,artist:s.now_playing.song.artist,album:s.now_playing.song.album,coverArt:s.now_playing.song.art}:{}}catch(o){console.warn("Error fetching Azuracast data",o)}return{}}startLiveUpdates(t){throw new Error("Method not implemented.")}stopLiveUpdates(){throw new Error("Method not implemented.")}}class ht{constructor(){P(this,"supportsLiveUpdates",!1)}async getNowPlayingAsync(t,e){try{const s=await(await fetch(t)).json();s!=null&&s.icestats.source||console.debug("No source found in Icecast response",s);let u=s.icestats.source;return Array.isArray(s.icestats.source)&&(u=s.icestats.source.find(n=>n.listenurl===e)),{hasData:!0,stationName:u.server_name,title:u.title}}catch(o){console.warn("Error fetching Icecast data",o)}return{}}startLiveUpdates(t){throw new Error("Method not implemented.")}stopLiveUpdates(){throw new Error("Method not implemented.")}}class pt{constructor(){P(this,"supportsLiveUpdates",!1)}async getNowPlayingAsync(t,e){var o,s,u,n;try{const f=await(await fetch(t)).json();return f?{hasData:!0,stationName:"Nightwave Plaza",title:(o=f==null?void 0:f.song)==null?void 0:o.title,artist:(s=f==null?void 0:f.song)==null?void 0:s.artist,album:(u=f==null?void 0:f.song)==null?void 0:u.album,coverArt:(n=f==null?void 0:f.song)==null?void 0:n.artwork_sm_src}:{}}catch(a){console.warn("Error fetching Plaza One data",a)}return{}}startLiveUpdates(t){throw new Error("Method not implemented.")}stopLiveUpdates(){throw new Error("Method not implemented.")}}const yt={icecast:new ht,"plaza-one":new pt,azuracast:new dt};function gt(r,t){r=r.replace(/\\/g,"/"),t=t.replace(/\\/g,"/"),r.endsWith("/")&&(r=r.slice(0,-1)),t.startsWith("/")&&(t=t.slice(1));const o=`${r}/${t}`.split("/"),s=[];for(const u of o)u===".."?s.pop():u!=="."&&s.push(u);return s.join("/")}class I{static async fetchAndParsePls(t){const o=await(await fetch(t)).text(),s=t.substring(0,t.lastIndexOf("/")+1);return I.parsePls(s,o)}static parsePls(t,e){const o=e.split(`
`).map(n=>n.trim()),s=[];let u={url:""};return o.forEach(n=>{if(n.startsWith("File")){u.url&&s.push(u),u={url:""};const a=n.match(/File\d+=(.+)/);a&&(a[1].startsWith("http")?u.url=a[1].trim():u.url=gt(t,a[1].trim()))}else if(n.startsWith("Title")){const a=n.match(/Title\d+=(.+)/);a&&(u.title=a[1].trim())}else if(n.startsWith("Artist")){const a=n.match(/Artist\d+=(.+)/);a&&(u.artist=a[1].trim())}else if(n.startsWith("Album")){const a=n.match(/Album\d+=(.+)/);a&&(u.album=a[1].trim())}}),u.url&&s.push(u),s}}function O(r){let t,e,o;function s(n){r[9](n)}let u={playContinuously:!0};return r[0]!==void 0&&(u.props=r[0]),t=new mt({props:u}),G.push(()=>rt(t,"props",s)),{c(){at(t.$$.fragment)},l(n){ot(t.$$.fragment,n)},m(n,a){lt(t,n,a),o=!0},p(n,a){const f={};!e&&a&1&&(e=!0,f.props=n[0],nt(()=>e=!1)),t.$set(f)},i(n){o||(k(t.$$.fragment,n),o=!0)},o(n){T(t.$$.fragment,n),o=!1},d(n){ut(t,n)}}}function wt(r){var h;let t,e,o,s,u,n,a,f,p,c=((h=r[0])==null?void 0:h.noise)&&O(r);return{c(){t=W("div"),e=W("audio"),u=x(),c&&c.c(),n=q(),this.h()},l(l){t=L(l,"DIV",{class:!0});var d=S(t);e=L(d,"AUDIO",{crossorigin:!0,src:!0}),S(e).forEach(b),d.forEach(b),u=R(l),c&&c.l(l),n=q(),this.h()},h(){var l;M(e,"crossorigin","anonymous"),e.muted=o=r[2].isMuting||!r[2].isOn||r[4].interruptedBy>0,D(e.src,s=(l=r[3])==null?void 0:l.url)||M(e,"src",s),e.controls=!0,M(t,"class","opacity-0 pointer-events-none")},m(l,d){E(l,t,d),$(t,e),r[8](e),E(l,u,d),c&&c.m(l,d),E(l,n,d),a=!0,f||(p=[z(e,"ended",r[5]),z(e,"error",r[5])],f=!0)},p(l,[d]){var i,g;(!a||d&20&&o!==(o=l[2].isMuting||!l[2].isOn||l[4].interruptedBy>0))&&(e.muted=o),(!a||d&8&&!D(e.src,s=(i=l[3])==null?void 0:i.url))&&M(e,"src",s),(g=l[0])!=null&&g.noise?c?(c.p(l,d),d&1&&k(c,1)):(c=O(l),c.c(),k(c,1),c.m(n.parentNode,n)):c&&(it(),T(c,1,1,()=>{c=null}),st())},i(l){a||(k(c),a=!0)},o(l){T(c),a=!1},d(l){l&&(b(t),b(u),b(n)),r[8](null),c&&c.d(l),f=!1,tt(p)}}}function _t(r,t,e){let o,s,u;N(r,_,y=>e(18,o=y)),N(r,K,y=>e(2,s=y)),N(r,ct,y=>e(4,u=y));let n,a,f,p,c=!1,h=[],l,{src:d=""}=t,{props:i={}}=t,g,A,m,w;V(async()=>{d.endsWith(".pls")?(h=await I.fetchAndParsePls(d),i.shufflePlaylist&&(h=h.sort(()=>Math.random()-.5))):h=[{url:d}],U(),i&&!(i!=null&&i.corsMitigation)&&(g=new AudioContext,A=g.createMediaElementSource(n),e(7,m=g.createGain()),w=g.createBiquadFilter(),w.type=(i==null?void 0:i.filterType)||"highpass",w.frequency.value=(i==null?void 0:i.filterFrequency)||0,A.connect(w),w.connect(m),m.connect(g.destination)),a=setTimeout(async()=>{n.play(),i!=null&&i.nowPlayingProvider&&(i!=null&&i.nowPlayingUrl)?(p=yt[i==null?void 0:i.nowPlayingProvider],p?(f=setInterval(async()=>{c||s.isOn&&s.isAudioInfoVisible&&await C()},15e3),await C()):i!=null&&i.description&&_.set({stationName:i==null?void 0:i.description})):i!=null&&i.description&&_.set({stationName:i.description})},500)});async function C(){if(p&&i.nowPlayingUrl){const y=await p.getNowPlayingAsync(i.nowPlayingUrl,d);if(c){v(_,o={},o);return}y&&v(_,o=y,o)}}et(()=>{c=!0,a&&clearTimeout(a),f&&clearInterval(f),v(_,o={},o),n&&e(1,n.src="",n)});function U(){h.length>0&&(e(3,l=h.shift()),h.push(l),e(1,n.src=l.url,n),n.play(),v(_,o={title:l.title,artist:l.artist,album:l.album},o))}function X(y){G[y?"unshift":"push"](()=>{n=y,e(1,n),e(0,i),e(2,s),e(7,m)})}function Y(y){i=y,e(0,i)}return r.$$set=y=>{"src"in y&&e(6,d=y.src),"props"in y&&e(0,i=y.props)},r.$$.update=()=>{r.$$.dirty&135&&n&&(!i||i!=null&&i.corsMitigation?e(1,n.volume=s.volume/100*B(i==null?void 0:i.volume,1),n):m&&(s.isMuting?e(7,m.gain.value=0,m):e(7,m.gain.value=s.volume*2/100*B(i==null?void 0:i.volume,1),m)))},[i,n,s,l,u,U,d,m,X,Y]}class kt extends H{constructor(t){super(),J(this,t,_t,wt,F,{src:6,props:0})}}export{kt as B,mt as W,ct as b,_ as n};
